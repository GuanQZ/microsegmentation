# iptables 运行机制与结构说明（面向汇报）

> 目标：用通俗语言说明 iptables “是什么、怎么分层、怎么工作、为什么规则顺序重要”，由浅入深、由全局到细节，领导也能听懂。

## 1. 一句话结论
iptables 是 Linux 内核里“网络流量的闸门规则表”。它把“流量经过的路径”拆成若干节点（链），每条规则就像“门禁条款”，按顺序匹配，命中了就执行动作。

---

## 2. 从全局视角理解

### 2.1 iptables 在系统中的位置
- **内核负责转发**：Linux 内核决定数据包怎么走。
- **iptables 提供规则**：用规则告诉内核“哪些放行、哪些阻断、哪些转发”。
- **不是一个服务进程**：iptables 是规则配置工具，规则真正运行在内核。

### 2.2 数据包的三种大方向（概念化）
1. **进主机**（Ingress）：外部访问本机服务。
2. **出主机**（Egress）：本机访问外部。
3. **穿过主机**（Forward）：主机作为网关转发别人流量。

> 例如：Kubernetes 节点上的 Pod 之间通信，多数属于“穿过主机（Forward）”。

---

## 3. 结构层级：表（Table）→ 链（Chain）→ 规则（Rule）

### 3.1 表（Table）= 规则“类别”
常用表（从高层理解即可）：
- **filter**：做“放行/阻断”。最常用。
- **nat**：做地址转换（如端口映射）。
- **mangle**：做包的标记或特殊处理。

> 绝大多数“安全隔离、放行/拒绝”的需求，都在 filter 表里。

### 3.2 链（Chain）= 流量必经的“关卡”
常见内置链（filter 表）：
- **INPUT**：进入本机的流量
- **OUTPUT**：本机发出的流量
- **FORWARD**：穿过本机的流量

> 链可以理解为“流程中的一个检查点”。

### 3.3 规则（Rule）= 条款
一条规则包含两部分：
- **匹配条件**：比如来源 IP、目的端口、协议等
- **动作（Target）**：比如 `ACCEPT`、`DROP`、`REJECT`、`JUMP`

> 规则按顺序执行，**先匹配先执行**。

---

## 4. 执行机制：先匹配先执行

### 4.1 顺序决定结果
iptables 从链的第一条规则开始检查：
- **命中就执行动作**（如放行/拒绝），通常就“结束”。
- **未命中就继续下一条**。

因此：
- 把“允许”放在前面，优先放行；
- 把“拒绝”放在前面，优先拦截；
- 规则顺序就是“优先级”。

### 4.2 链的默认动作
如果一条规则都没命中，最终会：
- **执行链的默认策略**（如 `ACCEPT` 或 `DROP`），
- 或者 **链尾再补一条“默认规则”**。

> 这就是“白名单”和“黑名单”的根本区别：
> - 白名单：默认拒绝，只放行明确允许的；
> - 黑名单：默认放行，只拒绝明确禁止的。

---

## 5. 跳转机制：把链当成“函数”调用

### 5.1 自定义链（User Chain）
iptables 允许定义“自定义链”，并在主链里跳转过去处理。

举例：
- 主链 `FORWARD` 先 `JUMP` 到 `MS-ROOT-OUT`（出向）和 `MS-ROOT-IN`（入向），
- 在根链中再按策略细分到每个 Deployment 的专用链处理。

这就像程序里的“函数调用”：
- 入口只做“分发”，
- 细节放在子链里，结构清晰、易维护。

### 5.2 为什么顺序依然关键
如果主链前面被插入了“更早的规则”，跳转可能被挤到后面，导致你的策略“优先级下降”。

> 这就是为什么我们强调“插入位置”和“持续对账”。

---

## 6. 典型场景：Kubernetes 节点

在 Kubernetes 节点上，常见链与作用：
- **kube-proxy**：管理 Service 相关规则。
- **Calico/Felix**：管理网络策略规则。
- **自研链**：用于业务隔离。

这些系统都会操作 `FORWARD` 链，因此“优先级和位置”是核心。

---

## 7. 一个通俗类比（给领导）

把 iptables 想成机场安检的“多部门串行检查”：
- **表**：不同部门的检查清单（证件检查/行李检查/安全审查），**同一位旅客会依次经过多个部门**。
- **链**：旅客所处的阶段（入口检查、转机检查、出站检查）。
- **规则**：每个部门的具体条款（比如证件有效、行李合规）。
- **顺序**：先过哪个部门、先查哪条条款，结果会不同。
- **默认动作**：都没问题时，是放行还是拦下复查。

---

## 8. 关键结论（汇报版）
1. iptables 是**内核里的规则系统**，iptables 命令只是配置工具。
2. 规则是**顺序执行**的，先匹配先执行，**顺序就是优先级**。
3. 链有默认动作：**默认放行=黑名单，默认拒绝=白名单**。
4. 自定义链让结构清晰，但**入口链的位置非常关键**。
5. 在 Kubernetes 上，多方都改 `FORWARD`，因此要**持续对账**保证我们的跳转在正确位置。

---

## 9. 常见问题（可选）

**Q1：如果一条规则都没匹配，会怎样？**  
A：取决于默认策略（`ACCEPT` 或 `DROP`）。

**Q2：只配置 `ACCEPT` 有意义吗？**  
A：有意义，它用于“白名单”，前提是默认拒绝。

**Q3：为什么要自定义链？**  
A：把复杂策略拆分，结构清晰、便于维护。

---

如需更深的技术细节（如连接跟踪、状态机、NAT 链路等），可在此文档基础上附加“技术附录”。
